name: Build & Deploy to EC2 (SSM + Docker)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      APP_NAME: cowmjucraft
      IMAGE: yunjin1213/cowmjucraft
      TAG_LATEST: latest
      ENV_DIR: /opt/cowmjucraft
      ENV_FILE: /opt/cowmjucraft/prod.env
      HOST_PORT: "8080"
      CONTAINER_PORT: "8080"

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ env.TAG_LATEST }}
            ${{ env.IMAGE }}:${{ github.sha }}

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy on EC2 via SSM (create env safely)
        shell: bash
        run: |
          set -euo pipefail

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy ${{ env.APP_NAME }} from GitHub Actions" \
            --parameters commands='[
              "set -e",
              "sudo mkdir -p /opt/cowmjucraft",
              "sudo tee /opt/cowmjucraft/prod.env > /dev/null << '\''EOF'\''",
              "SPRING_PROFILES_ACTIVE=prod",
              "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}",
              "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}",
              "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}",
              "ADMIN_USER_ID=${{ secrets.ADMIN_USER_ID }}",
              "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}",
              "JWT_SECRET=${{ secrets.JWT_SECRET }}",
              "JWT_EXPIRATION_SECONDS=${{ secrets.JWT_EXPIRATION_SECONDS }}",
              "AWS_REGION=${{ secrets.AWS_REGION }}",
              "AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}",
              "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}",
              "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}",
              "EOF",
              "sudo chmod 600 /opt/cowmjucraft/prod.env",
              "sudo docker pull yunjin1213/cowmjucraft:latest",
              "sudo docker stop cowmjucraft || true",
              "sudo docker rm cowmjucraft || true",
              "sudo docker run -d --name cowmjucraft --restart always -p 8080:8080 --env-file /opt/cowmjucraft/prod.env yunjin1213/cowmjucraft:latest",
              "sudo docker ps --filter name=cowmjucraft",
              "sudo grep -n '\''SPRING_DATASOURCE_URL'\'' /opt/cowmjucraft/prod.env || true"
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM CommandId: $COMMAND_ID"

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --output text